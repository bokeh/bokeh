name: Release - Build

env:
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  BOKEH_VERSION: ${{ github.event.inputs.version }}
  GH_TOKEN: ${{ secrets.GH_TOKEN }}
  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
  RELEASE_MAINTAINERS: ${{ secrets.RELEASE_MAINTAINERS }}
  SLACK_TOKEN: ${{ secrets.SLACK_BUILD_RELEASE_TOKEN }}

defaults:
  run:
     shell: bash -l {0}

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build a release for (e.g. 3.0.0, 2.4.0.dev8)"
        required: true

jobs:

  setup:
    runs-on: ubuntu-20.04

    outputs:
      checks: ${{ steps.generate-build-config.outputs.checks }}
      steps: ${{ steps.generate-build-config.outputs.steps }}

    steps:
      - name: Check Maintainer
        run: |
          if echo "$RELEASE_MAINTAINERS" | grep -qE "^${{github.actor}}$"; then
            echo
            echo "User is authorized to build releases, proceeding with release build for $BOKEH_VERSION"
            git config --global user.email "info@bokeh.org"
            git config --global user.name "${{github.actor}}"
            exit 0
          fi
          echo
          echo "User is NOT authorized to build releases, aborting..."
          echo
          echo "Please contact @bokeh/core about conducting releases."
          exit 1

      - uses: actions/checkout@v2
      - uses: conda-incubator/setup-miniconda@v2
        with:
          miniconda-version: 'latest'
          activate-environment: bk-release-build
          environment-file: ci/environment-release-build.yml

      - name: Install sampledata
        run: python bokeh/util/sampledata.py

      - name: Post install report
        run: |
          echo "$(which node) @ $(node --version)"
          echo "$(which npm) @ $(npm --version)"
          conda info
          conda list

      - name: Generate build configuration
        id: generate-build-config
        run: |
          python -m release generate-config $BOKEH_VERSION

          CHECKS=`python -m release generate-build-checks`
          echo ::set-output name=checks::${CHECKS}

          STEPS=`python -m release generate-build-steps`
          echo ::set-output name=steps::${STEPS}

  checks:
    runs-on: ubuntu-20.04
    needs:
      - setup

    strategy:
      max-parallel: 1
      matrix:
        check: ${{ fromJSON(needs.setup.outputs.checks) }}

    steps:
      - name: Build check (${{ matrix.check }})
        env:
          CHECK: ${{ maxtrix.check }}
        run: python -m release ${CHECK}

  build:
    runs-on: ubuntu-20.04
    needs:
      - checks

    strategy:
      max-parallel: 1
      matrix:
        step: ${{ fromJSON(needs.setup.outputs.steps) }}

    steps:
      - name: Build {{ matrix.step }})
        env:
          STEP: ${{ maxtrix.step }}
        run: python -m release ${STEP}
